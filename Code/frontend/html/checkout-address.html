<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Select Address | Agri-Fresh</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .checkout-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .address-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .address-card:hover {
            border-color: #4CAF50;
            background: #f8fff8;
        }
        
        .address-card.selected {
            border-color: #4CAF50;
            background: #e8f5e8;
        }
        
        .address-card .default-badge {
            background: #4CAF50;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        
        .add-address-form {
            background: #f9f9f9;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .add-address-form.show {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.5rem;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-outline {
            background: transparent;
            color: #4CAF50;
            border: 2px solid #4CAF50;
        }
        
        .btn-outline:hover {
            background: #4CAF50;
            color: white;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .error {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .success {
            color: #28a745;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .order-summary {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="checkout-container">
        <h1>Checkout - Select Delivery Address</h1>
        
        <!-- Order Summary -->
        <div class="order-summary">
            <h3>Order Summary</h3>
            <div id="order-items"></div>
            <div style="font-weight: bold; margin-top: 1rem;">
                Total: <span id="order-total">₱0</span>
            </div>
        </div>

        <!-- Address Selection -->
        <div class="address-section">
            <h3>Delivery Address</h3>
            <div id="address-list">
                <div class="loading">Loading addresses...</div>
            </div>
            
            <button type="button" class="btn-outline btn" onclick="toggleAddressForm()">
                + Add New Address
            </button>
        </div>

        <!-- Add Address Form -->
        <div id="add-address-form" class="add-address-form">
            <h4>Add New Address</h4>
            <form id="address-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="street">Street Address *</label>
                        <input type="text" id="street" name="street" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City *</label>
                        <input type="text" id="city" name="city" required>
                    </div>
                    <div class="form-group">
                        <label for="state">State/Province</label>
                        <input type="text" id="state" name="state">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="postal_code">Postal Code</label>
                        <input type="text" id="postal_code" name="postal_code">
                    </div>
                    <div class="form-group">
                        <label for="country">Country *</label>
                        <select id="country" name="country" required>
                            <option value="Philippines">Philippines</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is_default" name="is_default"> 
                        Set as default address
                    </label>
                </div>
                <button type="submit" class="btn">Save Address</button>
                <button type="button" class="btn btn-secondary" onclick="toggleAddressForm()">Cancel</button>
            </form>
            <div id="address-message"></div>
        </div>

        <!-- Payment Method -->
        <div class="payment-section" style="margin-top: 2rem;">
            <h3>Payment Method</h3>
            <div class="form-group">
                <label>
                    <input type="radio" name="payment_method" value="COD" checked> 
                    Cash on Delivery (COD)
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="radio" name="payment_method" value="Card" disabled> 
                    Credit/Debit Card (Coming Soon)
                </label>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" style="margin-top: 2rem;">
            <button class="btn btn-secondary" onclick="goBack()">Back to Cart</button>
            <button id="place-order-btn" class="btn" onclick="placeOrder()" disabled>Place Order</button>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script>
        let selectedAddressId = null;
        let customer_id = parseInt(localStorage.getItem("customer_id"), 10);
        let cartData = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (!customer_id) {
                alert('Please login to continue');
                window.location.href = 'login.php';
                return;
            }
            
            loadOrderSummary();
            loadAddresses();
        });

async function loadOrderSummary() {
  try {
    const response = await fetch(apiUrl(`cart?customer_id=${customer_id}`));
    const data = await response.json();
    cartData = data || [];

    // Build item lines
    const itemsHtml = (Array.isArray(cartData) && cartData.length > 0)
      ? cartData.map(item => {
          const total = (item.price_each || 0) * (item.quantity || 0);
          return `<div>${escapeHtml(item.name)} × ${item.quantity} — ${total.toLocaleString('en-PH', { style: 'currency', currency: 'PHP' })}</div>`;
        }).join('')
      : '<div>No items in cart.</div>';

    // Subtotal (items only)
    let subtotal = cartData.reduce((sum, item) => sum + (item.price_each || 0) * (item.quantity || 0), 0);

    // Default shipping
    let shippingFee = 50;
    let discountAmount = 0;
    let voucherCode = null;
    let voucherType = null;

    // Applied voucher from localStorage
    const raw = localStorage.getItem("applied_voucher");
    if (raw) {
      try {
        const v = JSON.parse(raw);
        voucherCode = v.code || null;
        voucherType = v.type || null;

        if (v.type === "discount") {
          if (v.discount_type === "percent") {
            discountAmount = subtotal * (v.discount_value / 100);
          } else if (v.discount_type === "fixed") {
            discountAmount = v.discount_value;
          }
        } else if (v.type === "free_shipping") {
          shippingFee = 0;
        }
      } catch (e) {
        console.warn("Invalid voucher in localStorage", e);
      }
    }

    // Compute total
    let totalAmount = subtotal + shippingFee - discountAmount;
    if (totalAmount < 0) totalAmount = 0;

    // Format values
    const subtotalFmt = subtotal.toLocaleString('en-PH', { style: 'currency', currency: 'PHP' });
    const shippingFmt = shippingFee > 0 
      ? shippingFee.toLocaleString('en-PH', { style: 'currency', currency: 'PHP' }) 
      : "Free";
    const discountFmt = discountAmount > 0 
      ? `- ${discountAmount.toLocaleString('en-PH', { style: 'currency', currency: 'PHP' })}`
      : "₱0.00";
    const totalFmt = totalAmount.toLocaleString('en-PH', { style: 'currency', currency: 'PHP' });

    // Render summary
    const orderSummaryEl = document.querySelector('.order-summary');
    orderSummaryEl.innerHTML = `
      <h3>Order Summary</h3>
      <div id="order-items">${itemsHtml}</div>
      <div style="margin-top:1rem; line-height:1.6;">
        <div>Subtotal: <strong>${subtotalFmt}</strong></div>
        <div>Shipping: <strong>${shippingFmt}</strong></div>
        <div>Voucher: ${voucherCode 
          ? `<strong>${escapeHtml(voucherCode)}</strong> <span style="color:#2e7d32">(${voucherType})</span> — <strong>${discountFmt}</strong>` 
          : '<em>None</em>'}
        </div>
        <div style="font-weight: bold; margin-top: 0.5rem;">
          Payable: <strong id="order-total">${totalFmt}</strong>
        </div>
      </div>
    `;
  } catch (error) {
    console.error("Failed to load order summary:", error);
    const orderSummaryEl = document.querySelector('.order-summary');
    orderSummaryEl.innerHTML = `
      <h3>Order Summary</h3>
      <div id="order-items"><p class="error">Failed to load order summary.</p></div>
      <div style="font-weight:bold; margin-top:1rem;">Total: <span id="order-total">₱0.00</span></div>
    `;
  }
}

/**
 * Small helper to avoid XSS when inserting product names / voucher codes
 * (safe to include in this file).
 */
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}


        async function loadAddresses() {
            try {
                const response = await fetch(apiUrl(`address?customer_id=${customer_id}`));
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayAddresses(result.data);
                } else {
                    document.getElementById('address-list').innerHTML = 
                        '<p>No addresses found. Please add a delivery address.</p>';
                }
            } catch (error) {
                console.error('Failed to load addresses:', error);
                document.getElementById('address-list').innerHTML = 
                    '<p class="error">Failed to load addresses.</p>';
            }
        }

        function displayAddresses(addresses) {
            const container = document.getElementById('address-list');
            
            if (addresses.length === 0) {
                container.innerHTML = '<p>No addresses found. Please add a delivery address.</p>';
                return;
            }

            container.innerHTML = addresses.map(addr => `
                <div class="address-card" onclick="selectAddress(${addr.address_id})" data-address-id="${addr.address_id}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${addr.street}</strong>
                            ${addr.is_default ? '<span class="default-badge">Default</span>' : ''}
                        </div>
                        <input type="radio" name="selected_address" value="${addr.address_id}" ${addr.is_default ? 'checked' : ''}>
                    </div>
                    <div>${addr.city}${addr.state ? ', ' + addr.state : ''} ${addr.postal_code || ''}</div>
                    <div>${addr.country}</div>
                </div>
            `).join('');

            // Auto-select default address
            const defaultAddress = addresses.find(addr => addr.is_default);
            if (defaultAddress) {
                selectedAddressId = defaultAddress.address_id;
                document.getElementById('place-order-btn').disabled = false;
            }
        }

        function selectAddress(addressId) {
            // Remove selection from all cards
            document.querySelectorAll('.address-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            const selectedCard = document.querySelector(`[data-address-id="${addressId}"]`);
            selectedCard.classList.add('selected');
            
            // Update radio button
            document.querySelector(`input[value="${addressId}"]`).checked = true;
            
            selectedAddressId = addressId;
            document.getElementById('place-order-btn').disabled = false;
        }

        function toggleAddressForm() {
            const form = document.getElementById('add-address-form');
            form.classList.toggle('show');
            
            if (form.classList.contains('show')) {
                document.getElementById('street').focus();
            }
        }

        // Handle address form submission
        document.getElementById('address-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const addressData = {
                customer_id: customer_id,
                action: 'add',
                street: formData.get('street'),
                city: formData.get('city'),
                state: formData.get('state'),
                postal_code: formData.get('postal_code'),
                country: formData.get('country'),
                is_default: formData.get('is_default') ? true : false
            };

            try {
                const response = await fetch(apiUrl('address'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(addressData)
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('address-message').innerHTML = 
                        '<div class="success">Address added successfully!</div>';
                    
                    // Reset form and hide it
                    e.target.reset();
                    setTimeout(() => {
                        toggleAddressForm();
                        loadAddresses(); // Reload addresses
                    }, 1000);
                } else {
                    document.getElementById('address-message').innerHTML = 
                        `<div class="error">${result.message}</div>`;
                }
            } catch (error) {
                console.error('Failed to add address:', error);
                document.getElementById('address-message').innerHTML = 
                    '<div class="error">Failed to add address. Please try again.</div>';
            }
        });
async function placeOrder() {
  if (!selectedAddressId) {
    alert("Please select a delivery address.");
    return;
  }

  const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;

  // ✅ Grab voucher from localStorage
  let voucherCode = null;
  const raw = localStorage.getItem("applied_voucher");
  if (raw) {
    try {
      const v = JSON.parse(raw);
      voucherCode = v.code || null;
    } catch (e) {
      console.warn("Invalid voucher in storage");
    }
  }

  const payload = {
    customer_id,
    address_id: selectedAddressId,
    payment_method: paymentMethod,
    voucher_code: voucherCode   // ✅ Send voucher code
  };

  try {
    const response = await fetch(apiUrl("orders"), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    if (result.status === "success") {
      alert("Order placed successfully!");
      localStorage.removeItem("applied_voucher"); // clear voucher after order
      window.location.href = `order-confirmation.html?order_id=${result.order_id}`;
    } else {
      alert("Error: " + result.message);
    }
  } catch (err) {
    console.error("Place order failed:", err);
    alert("Failed to place order. Try again.");
  }
}


        function goBack() {
            window.location.href = 'index.php';
        }
    </script>
</body>
</html>